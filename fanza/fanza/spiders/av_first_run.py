import scrapy
import json
import os


class AvFirstRunSpider(scrapy.Spider):
    name = "av_first_run"
    custom_settings = {
        "ITEM_PIPELINES": {
            "fanza.pipelines.AVPipeline": 300,
        }
    }

    async def start(self):
        query_path = os.path.join(os.path.dirname(
            __file__), '..', 'query', 'av_search.graphql')
        with open(query_path, "r", encoding="utf-8") as f:
            query = f.read()
        makers = [1219, 1227, 1398, 1509, 1548, 2376, 2661, 3131, 3152, 3254, 3255, 3537, 3783, 3784, 3890, 3925, 4094, 4096, 4236, 4468, 4469, 4500, 4523, 4551, 4552, 4553, 4555, 4581, 4582, 4583, 4584, 4585, 4608, 4641, 4643, 4676, 4725, 4726, 4775, 4776, 4777, 4802, 4803, 4804, 4808, 4809, 4833, 4834, 4835, 4836, 4837, 4864, 4865, 4986, 5009, 5032, 5034, 5061, 5130, 5183, 5184, 5210, 5237, 5238, 5288, 5314, 5337, 5338, 5413, 5414, 5456, 5486, 5518, 5534, 5552, 5584, 5603, 5604, 5606, 5607, 5622, 5626, 5644, 5648, 5665, 5669, 5699, 5700, 5701, 5714, 5715, 5791, 5792, 5793, 5809, 5825, 5826, 5827, 5860, 5864, 5877, 5922, 5924, 5938, 5957, 5961, 5994, 5996, 6009, 6010, 6012, 6029, 6032, 6033, 6048, 6049, 6103, 6118, 6134, 6171, 6172, 6176, 6208, 6210, 6226, 6228, 6229, 6260, 6276, 6277, 6279, 6282, 6283, 6288, 6289, 6290, 6293, 6294, 6295, 6296, 6300, 6302, 6303, 6304, 6305, 6306, 6307, 6308, 6309, 6311, 6312, 6313, 6321, 6322, 6324, 6325, 6326, 6327, 6328, 6329, 6330, 6331, 6332, 6333, 6334, 6336, 6337, 6338, 6339, 6340, 6342, 6343, 6344, 6345, 6347, 6349, 6350, 6351, 6353, 6355, 6359, 6360, 6361, 6362, 6363, 6364, 6365, 6366, 6368, 6372, 6373, 6374, 6375, 6376, 6377, 6380, 6381, 6382, 6384, 6386, 6387, 6388, 6392, 6393, 6394, 6395, 6396, 6400, 6401, 6404, 6405, 6406, 6407, 6412, 6413, 6415, 6416, 6417, 6420, 6426, 6428, 6429, 6430, 6431, 6436, 6437, 6438, 6439, 6440, 6441, 6444, 6445, 6446, 6448, 6450, 6451, 6452, 6453, 6454, 6455, 6457, 6458, 6459, 6460, 6461, 6464, 6465, 6466, 6468, 6469, 6470, 6471, 6472, 6473, 6476, 6477, 6478, 6480, 6481, 6482, 6485, 6486, 6487, 6488, 6489, 6491, 6492, 6493, 6494, 6495, 6496, 6498, 6500, 6501, 6503, 6504, 6505, 6506, 6509, 6510, 6511, 6512, 6513, 6514, 6515, 6516, 6518, 6520, 6522, 6523, 6524, 6525, 6526, 6527, 6528, 6529, 6530, 6531, 6532, 6533, 6534, 6535, 6536, 6537, 6538, 6539, 6540, 6541, 6542, 6544, 6545, 6546, 6547, 6548, 6549, 6553, 6554, 6555, 6556, 6559, 6561, 6562, 6566, 6567, 6568, 6569, 6570, 6571, 6573, 6574, 6575, 6576, 6577, 6578, 6581, 6582, 6584, 6585, 6586, 6587, 6589, 6592, 6593, 6595, 6596, 6598, 6599, 6600, 6601, 6602, 6603, 6604, 6606, 6607, 6608, 6609, 6610, 6611, 6612, 6613, 6614, 6615, 6616, 6617, 6618, 6619, 6621, 6625, 6626, 6627, 6628, 6629, 6630, 6631, 6633, 6635, 6636, 6637, 6639, 6641, 6642, 6644, 6645, 6646, 6647, 6648, 6649, 6650, 6652, 6653, 6654, 6655, 6656, 6658, 6660, 6662, 6663, 6665, 6666, 6667, 6668, 6669, 6670, 6671, 6673, 6674, 6675, 6676, 6677, 6678, 6679, 6681, 6682, 6683, 6684, 6685, 6686, 6688, 6689, 6690, 6691, 6692, 6693, 6695, 6696, 6697, 6699, 6701, 6702, 6703, 6705, 6706, 6707, 6708, 6709, 6710, 6712, 6713, 6715, 6716, 6718, 6720, 6722, 6723, 6724, 6725, 6726, 6727, 6728, 6729, 6730, 6731, 6732, 6733, 6734, 6735, 6736, 6737, 6738, 6739, 6741, 6742, 6743, 6744, 6745, 6747, 6748, 6749, 6750, 6752, 6753, 6754, 6755, 6756, 6757, 6758, 6759, 6760, 6761, 6762, 6763, 6764, 6765, 6766, 6767, 6768, 6769, 6770, 6771, 6772, 6773, 6774, 6775, 24015, 24760, 31268, 40001, 40003, 40004, 40005, 40006, 40007, 40008, 40012, 40013, 40014, 40016, 40018, 40019, 40022, 40024, 40025, 40027, 40028, 40030, 40032, 40033, 40034, 40035, 40036, 40037, 40038, 40039, 40041, 40042, 40043, 40045, 40046, 40047, 40048, 40051, 40052, 40053, 40058, 40064, 40067, 40068, 40070, 40071, 40072, 40074, 40075, 40077, 40080, 40081, 40082, 40086, 40106, 40107, 40121, 40135, 40137, 40138, 40142, 40143, 40144, 40145, 40146, 40147, 40150, 40152, 40157, 40159, 40160, 40161, 40162, 40164, 40166, 40169, 40172, 40174, 40175, 40177, 40178, 40183, 40185, 40192, 40194, 40200, 40297, 40298, 40303, 40304, 40317, 40380, 40381, 40382, 40383, 40384, 40386, 40387, 40388, 40389, 40391, 40393, 40394, 40395, 40398, 40399, 40400, 40401, 40402, 40403, 40404, 40405, 40406, 40407, 40408, 40409, 40410, 40411, 40412, 40413, 40414, 40415, 40416, 40417, 40418, 40419, 40421, 40422, 40423, 40424, 40425, 40428, 40429, 40430, 40431, 40432, 40433, 40435, 40438, 40439, 40440, 40443, 40444, 40446, 40447, 40448, 40449, 40450, 40451, 40452, 40453, 40454, 40455, 40456, 40457, 40458, 40459, 40460, 40461, 40462, 40463, 40466, 40467, 40468, 40470, 40471, 40473, 40474, 40475, 40476, 40477, 40478, 40480, 40481, 40482, 40483, 40484, 40485, 40486, 40487, 40488, 40489, 40490, 40491, 40492, 40493, 40494, 40495, 40496, 40498, 40500, 40501, 40503, 40504, 40506, 40507, 40509, 40510, 40514, 40516, 40517, 40518, 40519, 40520, 40521, 40522, 40523, 40524, 40526, 40527, 40528, 40530, 40531, 40532, 40533, 40534, 40540, 40542, 40543, 40544, 40545, 40546, 40549, 40551, 40552, 40553, 40555, 40556, 40557, 40558, 40559, 40561, 40562, 40563, 40564, 40565, 40567, 40569, 40570, 40571, 40572, 40573, 40574, 40575, 40577, 40578, 40579, 40580, 40581, 40582, 40583, 40584, 40585, 40586, 40587, 40588, 40590, 40592, 40593, 40594, 40595, 40596, 40598, 40599, 40600, 40601, 40602, 40604, 40605, 40606, 40607, 40608, 40609, 40610, 40611, 40613, 40614, 40615, 45002, 45012, 45016, 45017, 45018, 45022, 45023, 45037, 45046, 45047, 45048, 45050, 45051, 45052, 45058, 45059, 45061, 45068, 45099, 45103, 45110, 45114, 45131, 45134, 45144, 45147, 45148, 45149, 45151, 45152, 45163, 45165, 45176, 45195, 45196, 45207, 45215, 45216, 45217, 45230, 45237, 45241, 45242, 45249, 45250, 45255, 45256, 45259, 45260, 45262, 45263, 45264, 45265, 45270, 45276, 45277, 45278, 45281, 45283, 45286, 45287, 45289, 45290, 45292, 45298, 45302, 45306, 45313, 45315, 45317, 45319, 45320, 45321, 45326, 45328, 45329, 45337, 45338, 45339, 45340, 45341, 45344, 45346, 45347, 45349, 45350, 45351, 45356, 45357, 45360, 45362, 45363, 45366, 45367, 45368, 45371, 45384, 45386, 45387, 45392, 45393, 45394, 45397, 45401, 45412, 45414, 45416, 45417, 45424, 45425, 45427, 45429, 45430, 45434, 45436, 45438, 45443, 45444, 45445, 45446, 45450, 45452, 45453, 45455, 45457, 45460, 45466, 45467, 45468, 45470, 45474, 45475, 45476, 45478, 45479, 45480, 45486, 45489, 45494, 45500, 45504, 45507, 45514, 45516, 45519, 45521, 45522, 45524, 45530, 45531, 45532, 45537, 45540, 45543, 45545, 45546, 45552, 45553, 45556, 45562, 45565, 45566, 45571, 45572, 45574, 45575, 45580, 45581, 45583, 45585, 45588, 45590, 45591, 45598, 45621, 45625, 45626, 45627, 45629, 45637, 45641, 45642, 45643, 45649, 45650, 45655, 45656, 45662, 45664, 45665, 45667, 45668, 45671, 45674, 45687, 45688, 45691, 45700, 45701, 45702, 45710, 45716, 45725, 45726, 45732, 45734, 45736, 45737, 45744, 45745, 45748, 45749, 45750, 45751, 45752, 45757, 45758, 45760, 45762, 45767, 45771, 45775, 45781, 45782, 45783, 45790, 45791, 45793, 45802, 45806, 45807, 45825, 45830, 45831, 45837, 45843, 45846, 45847, 45852, 45855, 45858, 45860, 45867, 45883, 45887, 45891, 45896, 45900, 45906, 45911, 45914, 45917, 45918, 45920, 45921, 45926, 45928, 45934, 45940, 45941, 45943, 45944, 45950, 45958, 45961, 45968, 45969, 45973, 45977, 45978, 45985, 45987, 45989, 45990, 45992, 45994, 45995, 45998, 45999, 46001, 46002, 46003, 46005, 46006, 46009, 46015, 46017, 46018, 46024, 46028, 46031, 46034, 46037, 46038, 46039, 46040, 46042, 46047, 46051, 46054, 46060, 46068, 46073, 46074, 46076, 46077, 46092, 46093, 46098, 46099, 46101, 46103, 46105, 46109, 46113, 46115, 46116, 46122, 46126, 46129, 46134, 46135, 46140, 46145, 46154, 46155, 46158, 46160, 46161, 46162, 46165, 46166, 46172, 46173, 46174, 46175, 46176, 46177, 46181, 46185, 46187, 46191, 46193, 46197, 46199, 46212, 46213, 46215, 46219, 46220, 46228, 46230, 46231, 46232, 46237, 46240, 46241, 46242, 46245, 46246, 46248, 46251, 46252, 46253, 46255, 46256, 46258, 46259, 46260, 46263, 46264, 46272, 46274, 46277, 46279, 46280, 46282, 46283, 46286, 46287, 46295, 46296, 46300, 46301, 46302, 46308, 46314, 46315, 46320, 46322, 46326, 46331, 46332, 46333, 46334, 46350, 46359, 46360, 46364, 46368, 46369, 46372, 46373, 46374, 46375, 46376, 46377, 46378, 46379, 46381, 46384, 46394, 46395, 46396, 46402, 46407, 46409, 46414, 46415, 46420, 46422, 46424, 46425, 46429, 46433, 46437, 46438, 46439, 46440, 46442, 46443, 46444, 46446, 46448, 46450, 46451, 46453, 46454, 46456, 46457, 46459, 46460, 46463, 46464, 46465, 46468, 46470, 46471, 46475, 46476, 46478, 46479, 46482, 46483, 46484, 46485, 46487, 46488, 46490, 46491, 46493, 46495, 46496, 46498, 46499, 46500, 46501, 46503, 46504, 46508, 46509, 46510, 46511, 46513, 46514, 46515, 46516, 46517, 46519, 46521, 46522, 46523, 46525, 46526, 46528, 46529, 46530, 46531, 46533, 46534, 46535, 46536, 46538, 46540, 46541, 46542, 46543, 46544, 46545, 46546, 46547, 46548, 46550, 46555, 46556, 46557, 46558, 46559, 46560, 46562, 46563, 46564, 46565, 46567, 46568, 46569, 46570, 46571, 46574, 46575, 46576, 46578, 46579, 46580, 46581, 46582, 46584, 46585, 46586, 46589, 46590, 46592, 46593, 46594, 46595, 46596, 46597, 46598, 46599, 46600, 46607, 46609, 46610, 46611, 46612, 46613, 46614, 46616, 46617, 46618, 46619, 46620, 46621, 46622, 46623, 46624, 46625, 46627, 46628, 46629, 46630, 46631, 46632, 46633, 46636, 46637, 46638, 46639, 46641, 46642, 46643, 46646, 46648, 46649, 46650, 46651, 46652, 46653, 46654, 46655, 46656, 46657, 46658, 46659, 46661, 46662, 46664, 46665, 46667, 46669, 46670, 46672, 46674, 46676, 46677, 46678, 46679, 46680, 46681, 46682, 46683, 46684, 46685, 46686, 46687, 46688, 46689, 46691, 46692, 46693, 46694, 46695, 46696, 46697, 46700, 46701, 46704, 46705, 46706, 46707, 46708, 46711, 46712, 46713, 46714, 46715, 46716, 46717, 46718, 46719, 46721, 46722, 46723, 46725, 46726, 46727, 46728, 46729, 46730, 46732, 46735, 46738, 46742, 46743, 58025, 60041, 60091, 60093, 60101, 60109, 60201, 60263, 60312, 60381, 60392, 60438, 60457, 60472, 60715, 60721, 60742, 60747, 60748, 60753, 60794, 60817, 60819, 60821, 60828, 60845, 60849, 60851, 60854, 60856, 60864, 60871, 60874, 60886, 66009, 66056, 66121, 66167, 66230, 66255, 66318, 66341, 66364, 66385, 66424, 66425, 66489, 66506, 66520, 66555, 66556, 66563, 66594, 66599, 66612, 66979, 300005, 300007, 300017, 300024, 300030, 300035, 300044, 300076, 300077, 300078, 300079, 300087, 300109, 300111, 300115, 300117, 300121, 300133, 300150, 300153, 300169, 300183, 300187, 300200, 300201, 300210, 300217, 300228, 300245, 300246, 300248, 300255, 300257, 300258, 300263, 300268, 300274, 300275, 300283, 300298, 300318, 300340, 300342, 300345, 300347, 300348, 300349, 300357, 300358, 300360, 300364, 300406, 300408, 300411, 300412, 300416, 300420, 300421, 300430, 300431, 300440, 300441, 300445, 300446, 300455, 300456, 300461, 300468, 300469, 300474, 300483, 300484, 300492, 300493, 300496, 300497, 300498, 300499, 300508, 300509, 300517, 300539, 300545, 300546, 300548, 300556, 300559, 300566, 300568, 300569, 300575, 300581, 300585, 300586, 300636, 300637, 300638, 300639, 300651, 300652, 300660, 300682, 300687, 300688, 300692, 300701, 300703, 300704, 300714, 300719, 300724, 300725, 300731, 300732, 300735, 300739, 300745, 300757, 300771, 300772, 300773, 300776, 300777, 300782, 300783, 300881, 300882, 300889, 300911, 300930, 300937, 300939, 300948, 300957, 300958, 300966, 300986, 300988, 300994, 300995, 300996, 301028, 301090, 301094, 301126, 301127, 301154, 301179, 301195, 301196, 301197, 301212, 301225, 301229, 301233, 301235, 301236, 301237, 301239, 301240, 301259, 301262, 301276, 301286, 301288, 301296, 301301, 301304, 301305, 301326, 301327, 301328, 301348, 301369, 301370, 301387, 301388, 301389, 301438, 301442, 301447, 301466, 301475, 301476, 301477, 301478, 301494, 301504, 301506, 301516, 301517, 301518, 301524, 301525, 301527, 301533, 301559, 301560, 301566, 301569, 301579, 301584, 301585, 301586, 301587, 301597, 301599, 301603, 301605, 301619, 301620, 301621, 301627, 301635, 301664, 301669, 301691, 301709, 301712, 301713, 301715, 301716, 301744, 301760, 301761, 301769, 301816, 301825, 301830, 301845, 301869, 301883, 301893, 301895, 301901, 301903, 301929, 301931, 301936, 301937, 301938, 301939, 301951, 301952, 301964, 301981, 302009, 302010, 302033, 302035, 302039, 302046, 302047, 302056, 302057, 302058, 302060, 302072, 302085, 302086, 302189, 302191, 302192, 302201, 302202, 302203, 302210, 302216, 302221, 302240, 302241, 302277, 302278, 302281, 302282, 302310, 302311, 302313, 302314, 302338, 302360, 302366, 302379, 302400, 302403, 302404, 302405, 302406, 302408, 302412, 302432, 302435, 302437, 302447, 302448, 302450, 302452, 302473, 302480, 302490, 302499, 302511, 302586, 302618, 302813, 302872, 303030, 303031, 303100, 303101, 303103, 303114, 303115, 303191, 303252, 303314, 303378, 303379, 303380, 303406, 303407, 303435, 303436, 303437, 303452, 303453, 303534, 303535, 303547, 303548, 303612, 303642, 303643, 303685, 303686, 303864, 303865, 303892, 303893, 303901, 303957, 304033, 304038, 304048, 304135, 304138, 304152, 304154, 304158, 304159, 304178, 304213, 304272, 304281, 304286, 304287, 304304, 304305, 304332, 304346, 304351, 304392, 304393, 304455, 304510, 304514, 304515, 304530, 304531, 304536, 304538, 304539, 304550, 304576, 304577, 304578, 304579, 304580, 304581, 304582, 304583, 304598, 304614, 304618, 304623, 304655, 306040, 306046, 306047, 306068, 306069, 306073, 306080, 306084, 306085, 306088, 306089, 306090, 306095, 306096, 306102, 306115, 306116, 306170, 306180, 306192, 306193, 306201, 307874, 307875, 307886, 307906, 307929, 307930, 307931, 307932, 307951, 308040, 308041, 308043, 308045, 308046, 308062, 308066, 308077, 308084, 308119, 308121, 308209, 308226, 308264, 308296, 308314, 308316, 308317, 308318, 308330, 308345, 308351, 308352, 308353, 308359, 308374, 308377, 308417, 308420, 308435, 308453, 308510, 308551, 308560, 308573, 308580, 308600, 308604, 308608, 308609, 308654, 308660, 308669, 308897, 308902, 308903, 308916, 308917, 308942, 308947, 308980, 309415, 309416, 309450, 309451, 309470, 309497, 309503, 309509, 309513, 309531, 309544, 309583, 309588, 309589, 309590, 309591, 309601, 309602, 309603, 309604, 309623, 309665, 309666, 309720, 309755, 309761, 309779, 309780, 309803, 309804, 309805, 309806, 309832, 309833, 309843, 309865, 309876, 309877, 309878, 309922, 309928, 309929, 309940, 309944, 309945, 309951, 309963, 309981, 309994, 309995, 310054, 310139, 310142, 310207, 310295, 310296, 310324, 310357, 310364, 310376, 310385, 310386, 310408, 310433, 310456, 310457, 310473, 310486, 310499, 310531, 310544, 310552, 310553, 310606, 310622, 310629, 310639, 310649, 310667, 310685, 310686, 310709, 310730, 310731, 310758, 310780, 310800, 310801, 310802, 310820, 310824, 310826, 310845, 310846, 310847, 310848, 310849, 310850, 310851, 310852, 310853, 310854, 310862, 310898, 310907, 310908, 310909, 310910, 310941, 310942, 310943, 310970, 310971, 310972, 310986, 310995, 311043, 311051, 311052, 311054, 311055, 311062, 311106, 311117, 311133, 311134, 311155, 311161, 311165, 311168, 311169, 311173, 311174, 311180, 311219, 311252, 311287, 311300, 311368, 311369, 311370, 311405, 311406, 311407, 311410, 311411, 311455, 311477, 311478, 311503, 311504, 311514, 311515, 311570, 311576, 311577, 311578, 311734, 311749, 311761, 311788, 311804, 311835, 311837, 311839, 311840, 311865, 311871, 311872, 311913, 311937, 311945, 311948, 311949, 311950, 311951, 311955, 312004, 312018, 312022, 312025, 312076, 312079, 312133, 312141, 312163, 312191, 312247, 312284, 312422]
        url = "https://api.video.dmm.co.jp/graphql"
        for maker in makers:
            payload = {
                "query": query,
                "variables": {
                    "filter": {
                        "isSaleItemsOnly": False,
                        "makerIds": {
                            "ids": [
                                {
                                    "id": str(maker)
                                }
                            ],
                            "op": "AND"
                        }
                    },
                    "limit": 120,
                    "offset": 0
                }
            }
            yield scrapy.Request(
                url=url,
                method="POST",
                body=json.dumps(payload),
                callback=self.parse,
                meta={"payload": payload}
            )

    def parse(self, response):
        data = json.loads(response.text)
        result = data["data"]["legacySearchPPV"]["result"]
        item_query_path = os.path.join(os.path.dirname(
            __file__), '..', 'query', 'content_page_data.graphql')
        with open(item_query_path, "r", encoding="utf-8") as f:
            item_query = f.read()
        for content in result["contents"]:
            item_payload = {
                "query": item_query,
                "variables": {
                    "id": content["id"],
                    "isAmateur": False,
                    "isAnime": False,
                    "isAv": True
                }
            }
            yield scrapy.Request(
                url=response.url,
                method="POST",
                body=json.dumps(item_payload),
                callback=self.parse_item,
                meta={"maker_id": response.meta["payload"]["variables"]["filter"]["makerIds"]["ids"][0]["id"]}
            )
        if result["pageInfo"]["hasNext"]:
            next_payload = response.meta["payload"]
            next_payload["variables"]["offset"] += 120
            yield scrapy.Request(
                url=response.url,
                method="POST",
                body=json.dumps(next_payload),
                callback=self.parse,
                meta={"payload": next_payload}
            )

    def parse_item(self, response):
        data = json.loads(response.text)
        item = data["data"]["ppvContent"]
        item["maker_id"] = response.meta["maker_id"]
        yield item
