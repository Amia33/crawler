import scrapy
import json
import os


class AvSpider(scrapy.Spider):
    name = "av"
    custom_settings = {
        "ITEM_PIPELINES": {
            "fanza.pipelines.AVPipeline": 300,
        }
    }

    async def start(self):
        query_path = os.path.join(os.path.dirname(
            __file__), '..', 'query', 'av_search.graphql')
        with open(query_path, "r", encoding="utf-8") as f:
            query = f.read()
        makers = [
            "40486",
            "5714",
            "66979",
            "5715",
            "40194",
            "5534",
            "5034",
            "40410",
            "6172",
            "6336",
            "46396",
            "309780",
            "40004",
            "309928",
            "300257",
            "6520",
            "60886",
            "300882",
            "6538",
            "301569",
            "1219",
            "301127",
            "45134",
            "5701",
            "46581",
            "300889",
            "40022",
            "6621",
            "6496",
            "45522",
            "6426",
            "6446",
            "40159",
            "6307",
            "45289",
            "311055",
            "301709",
            "6660",
            "46006",
            "46688",
            "6009",
            "45494",
            "311062",
            "304538",
            "46684",
            "45556",
            "306073",
            "1227",
            "66056",
            "46726",
            "45313",
            "46068",
            "45664",
            "306046",
            "304614",
            "40160",
            "46487",
            "40463",
            "45758",
            "40030",
            "6635",
            "45546",
            "304305",
            "4725",
            "6611",
            "46662",
            "46287",
            "45992",
            "46580",
            "45037",
            "6734",
            "46240",
            "45306",
            "6762",
            "6610",
            "300704",
            "45562",
            "5606",
            "6715",
            "40081",
            "40161",
            "40039",
            "308119",
            "40106",
            "311106",
            "40012",
            "6455",
            "310364",
            "45475",
            "6764",
            "46409",
            "311577",
            "46446",
            "5210",
            "45867",
            "6707",
            "309929",
            "66612",
            "46364",
            "60041",
            "5032",
            "45051",
            "45264",
            "40552",
            "46618",
            "6626",
            "40531",
            "301603",
            "45649",
            "311043",
            "310685",
            "46730",
            "46578",
            "6290",
            "46531",
            "6609",
            "40424",
            "45846",
            "300508",
            "300187",
            "309832",
            "309878",
            "6730",
            "6642",
            "45891",
            "46248",
            "301559",
            "300275",
            "45732",
            "40384",
            "45999",
            "45906",
            "60817",
            "5809",
            "46246",
            "46175",
            "40303",
            "5699",
            "45918",
            "45263",
            "45668",
            "60721",
            "45283",
            "40146",
            "6706",
            "5518",
            "6754",
            "45858",
            "45674",
            "45468",
            "301236",
            "302009",
            "302511",
            "311134",
            "309995",
            "3255",
            "6689",
            "311219",
            "40544",
            "40027",
            "6641",
            "46701",
            "46456",
            "45507",
            "45061",
            "40077",
            "46713",
            "302618",
            "46443",
            "300545",
            "309591",
            "46564",
            "300077",
            "40086",
            "45427",
            "6478",
            "46173",
            "6530",
            "40380",
            "4585",
            "46126",
            "46495",
            "6420",
            "304598",
            "46503",
            "6656",
            "40383",
            "300246",
            "45276",
            "45434",
            "46692",
            "45414",
            "46252",
            "6339",
            "66341",
            "311155",
            "46295",
            "3152",
            "302189",
            "306102",
            "4776",
            "40032",
            "6361",
            "40200",
            "301715",
            "6523",
            "60794",
            "45588",
            "6510",
            "6228",
            "6308",
            "45831",
            "45215",
            "46283",
            "6531",
            "45701",
            "45793",
            "46116",
            "45941",
            "3784",
            "6602",
            "46655",
            "6481",
            "40422",
            "6226",
            "40455",
            "5669",
            "46559",
            "300725",
            "302039",
            "45667",
            "46548",
            "45438",
            "66318",
            "5603",
            "6471",
            "4726",
            "302047",
            "5791",
            "6372",
            "46721",
            "46598",
            "45321",
            "4236",
            "4834",
            "6312",
            "40007",
            "5061",
            "304213",
            "5238",
            "46525",
            "46704",
            "60753",
            "6333",
            "6549",
            "6405",
            "6644",
            "45302",
            "46728",
            "310800",
            "40473",
            "6452",
            "310606",
            "6681",
            "2376",
            "6603",
            "46334",
            "5864",
            "6571",
            "308045",
            "46074",
            "6636",
            "66506",
            "46451",
            "304159",
            "301712",
            "46464",
            "45144",
            "46228",
            "6208",
            "46376",
            "310824",
            "304346",
            "6453",
            "302447",
            "310972",
            "6744",
            "310433",
            "6437",
            "45545",
            "6503",
            "6671",
            "300201",
            "40052",
            "46483",
            "40407",
            "6416",
            "300416",
            "300408",
            "6608",
            "4833",
            "46424",
            "6688",
            "6282",
            "304514",
            "45737",
            "6736",
            "300739",
            "301937",
            "40540",
            "45553",
            "46478",
            "301883",
            "46482",
            "3131",
            "308600",
            "45592",
            "4469",
            "6574",
            "6386",
            "6675",
            "5622",
            "6375",
            "45338",
            "308084",
            "311180",
            "311174",
            "40458",
            "4777",
            "6350",
            "5237",
            "6639",
            "46707",
            "6441",
            "310854",
            "46658",
            "302360",
            "46557",
            "6494",
            "309755",
            "306069",
            "45504",
            "6575",
            "309922",
            "45367",
            "6457",
            "300701",
            "60457",
            "46425",
            "46322",
            "300948",
            "40476",
            "5860",
            "6482",
            "6374",
            "4581",
            "301769",
            "46177",
            "310499",
            "40386",
            "66230",
            "6573",
            "310898",
            "46037",
            "301197",
            "66385",
            "40033",
            "6396",
            "308226",
            "6540",
            "310139",
            "6600",
            "6747",
            "310386",
            "40142",
            "60747",
            "60715",
            "40034",
            "5184",
            "60472",
            "6349",
            "60748",
            "6749",
            "6381",
            "6616",
            "6686",
            "66255",
            "40035",
            "46522",
            "300777",
            "45524",
            "5288",
            "300035",
            "40013",
            "6347",
            "6171",
            "303115",
            "60845",
            "45474",
            "312022",
            "6755",
            "40150",
            "6532",
            "40014",
            "46649",
            "3783",
            "46545",
            "40135",
            "6362",
            "6606",
            "46628",
            "40404",
            "40071",
            "304048",
            "45591",
            "6562",
            "45349",
            "46695",
            "6585",
            "45655",
            "40036",
            "45242",
            "6327",
            "4551",
            "46706",
            "6731",
            "301259",
            "6631",
            "304287",
            "46685",
            "310357",
            "4676",
            "5793",
            "46574",
            "5924",
            "40053",
            "45968",
            "6702",
            "4802",
            "6305",
            "6753",
            "6683",
            "45430",
            "46629",
            "6283",
            "6592",
            "45099",
            "6774",
            "40145",
            "46672",
            "6586",
            "300268",
            "45716",
            "6545",
            "6049",
            "304033",
            "46320",
            "300456",
            "40477",
            "6489",
            "301517",
            "6334",
            "304038",
            "40391",
            "40564",
            "310531",
            "311117",
            "46115",
            "40543",
            "46556",
            "6454",
            "46543",
            "45195",
            "46530",
            "46073",
            "45149",
            "300446",
            "301635",
            "6678",
            "6685",
            "6460",
            "40162",
            "60312",
            "45292",
            "45998",
            "46302",
            "46682",
            "303534",
            "6401",
            "312141",
            "308654",
            "40177",
            "6679",
            "312004",
            "45691",
            "6673",
            "60819",
            "308435",
            "45543",
            "6534",
            "40606",
            "45356",
            "40475",
            "5922",
            "45489",
            "46009",
            "46219",
            "40468",
            "300357",
            "60438",
            "6658",
            "300255",
            "40192",
            "302240",
            "45163",
            "45429",
            "306201",
            "6377",
            "45250",
            "46031",
            "6705",
            "46060",
            "4836",
            "40466",
            "46607",
            "6444",
            "6691",
            "6581",
            "5994",
            "6295",
            "66489",
            "306193",
            "301195",
            "46176",
            "46154",
            "46594",
            "46140",
            "46407",
            "6599",
            "45110",
            "6697",
            "46586",
            "40037",
            "45050",
            "3925",
            "45394",
            "40389",
            "46619",
            "45973",
            "40038",
            "6765",
            "40143",
            "40074",
            "45802",
            "45386",
            "6596",
            "6684",
            "6646",
            "6627",
            "45412",
            "6526",
            "302480",
            "6300",
            "45500",
            "46165",
            "46625",
            "6477",
            "6430",
            "6712",
            "5130",
            "46333",
            "40571",
            "6445",
            "6438",
            "6756",
            "303548",
            "6493",
            "6692",
            "6703",
            "302282",
            "46528",
            "6690",
            "5414",
            "6436",
            "6769",
            "6515",
            "40400",
            "4584",
            "6537",
            "6451",
            "302010",
            "46256",
            "45751",
            "6464",
            "300340",
            "45315",
            "45583",
            "40438",
            "300345",
            "6289",
            "6342",
            "308062",
            "309503",
            "301597",
            "301301",
            "310376",
            "46609",
            "302056",
            "301605",
            "6695",
            "310995",
            "300117",
            "40579",
            "300996",
            "6709",
            "301296",
            "46670",
            "6569",
            "45852",
            "302057",
            "300228",
            "300469",
            "45351",
            "40393",
            "6667",
            "46490",
            "307906",
            "302450",
            "6012",
            "60874",
            "40615",
            "6322",
            "45914",
            "6514",
            "6032",
            "40298",
            "45317",
            "45837",
            "45767",
            "301825",
            "40580",
            "45532",
            "45530",
            "45450",
            "40403",
            "5996",
            "46135",
            "6760",
            "66167",
            "303685",
            "6516",
            "6652",
            "6382",
            "5644",
            "45237",
            "40430",
            "5604",
            "40519",
            "60263",
            "46331",
            "301447",
            "60109",
            "6010",
            "300420",
            "45565",
            "40596",
            "6701",
            "301094",
            "45401",
            "6650",
            "302448",
            "309779",
            "40570",
            "309951",
            "46622",
            "40454",
            "46332",
            "45368",
            "46679",
            "40304",
            "40478",
            "311839",
            "46646",
            "6504",
            "45397",
            "40474",
            "6559",
            "46725",
            "6735",
            "46272",
            "45943",
            "6670",
            "6373",
            "301518",
            "45016",
            "46521",
            "6728",
            "300431",
            "6458",
            "6331",
            "45470",
            "302046",
            "301090",
            "303547",
            "301901",
            "46047",
            "46402",
            "45360",
            "304152",
            "46280",
            "60381",
            "6338",
            "6737",
            "45147",
            "46450",
            "40428",
            "5337",
            "40435",
            "310910",
            "40183",
            "45346",
            "40019",
            "300298",
            "6723",
            "6332",
            "60101",
            "60392",
            "4641",
            "309981",
            "6276",
            "6593",
            "6309",
            "302033",
            "6535",
            "6589",
            "6718",
            "46582",
            "46595",
            "45103",
            "300586",
            "6738",
            "45286",
            "300966",
            "6724",
            "45467",
            "6501",
            "45241",
            "6630",
            "6473",
            "6584",
            "5552",
            "6476",
            "300210",
            "45843",
            "309720",
            "66594",
            "302277",
            "46433",
            "40487",
            "6541",
            "40388",
            "300776",
            "307874",
            "311948",
            "301586",
            "46593",
            "45637",
            "45961",
            "46656",
            "46499",
            "6553",
            "45424",
            "6029",
            "40178",
            "6459",
            "46600",
            "46279",
            "6485",
            "46215",
            "6674",
            "40003",
            "302872",
            "46018",
            "6466",
            "66424",
            "46500",
            "312018",
            "40574",
            "6470",
            "46633",
            "46155",
            "309415",
            "45059",
            "45590",
            "46643",
            "6522",
            "46637",
            "46300",
            "6417",
            "46569",
            "46667",
            "6629",
            "307875",
            "300283",
            "312191",
            "301560",
            "6582",
            "309544",
            "40169",
            "301494",
            "308669",
            "310780",
            "310385",
            "5877",
            "46024",
            "40467",
            "300115",
            "311951",
            "6303",
            "6288",
            "309803",
            "45320",
            "6633",
            "6645",
            "302085",
            "46158",
            "310553",
            "40041",
            "6118",
            "40453",
            "6529",
            "1398",
            "46465",
            "6465",
            "6518",
            "6716",
            "303191",
            "45571",
            "40382",
            "6696",
            "60742",
            "45339",
            "40042",
            "6663",
            "45319",
            "45476",
            "6739",
            "46422",
            "4835",
            "311950",
            "45017",
            "40025",
            "6665",
            "46034",
            "304510",
            "308040",
            "309945",
            "300937",
            "45249",
            "4808",
            "301816",
            "301212",
            "40418",
            "40447",
            "4775",
            "40001",
            "6511",
            "45216",
            "309509",
            "6302",
            "4643",
            "45048",
            "6648",
            "306170",
            "301587",
            "40522",
            "6761",
            "40521",
            "46213",
            "300546",
            "300783",
            "300509",
            "300566",
            "46678",
            "40416",
            "46516",
            "46648",
            "46691",
            "46659",
            "310552",
            "45887",
            "301579",
            "45531",
            "4804",
            "45455",
            "6757",
            "46375",
            "6461",
            "310629",
            "6407",
            "46429",
            "4582",
            "302499",
            "66556",
            "45457",
            "6613",
            "302314",
            "301938",
            "60864",
            "6260",
            "6726",
            "4803",
            "45281",
            "312079",
            "309416",
            "308453",
            "40387",
            "45580",
            "46463",
            "301237",
            "46174",
            "6614",
            "301288",
            "40520",
            "46360",
            "6566",
            "302338",
            "6366",
            "4837",
            "46258",
            "6770",
            "46599",
            "5938",
            "6364",
            "6682",
            "45519",
            "45466",
            "40414",
            "304655",
            "301929",
            "300005",
            "6666",
            "6340",
            "40147",
            "300585",
            "40586",
            "302216",
            "46230",
            "301566",
            "40523",
            "6500",
            "6328",
            "6653",
            "5607",
            "60849",
            "6448",
            "6748",
            "46579",
            "6758",
            "6561",
            "6766",
            "308947",
            "45337",
            "46242",
            "40423",
            "6568",
            "40518",
            "300660",
            "310622",
            "3254",
            "46488",
            "301524",
            "40072",
            "304550",
            "40068",
            "46546",
            "40498",
            "6359",
            "45791",
            "45700",
            "302379",
            "60851",
            "300539",
            "301931",
            "40461",
            "46448",
            "6279",
            "46259",
            "6554",
            "310295",
            "45287",
            "6729",
            "6513",
            "6528",
            "308359",
            "5826",
            "300911",
            "46617",
            "40166",
            "45047",
            "45165",
            "46015",
            "302586",
            "6617",
            "6555",
            "46395",
            "303901",
            "6394",
            "303314",
            "5486",
            "6527",
            "6741",
            "40534",
            "4552",
            "300150",
            "46562",
            "5626",
            "6311",
            "40067",
            "45825",
            "6512",
            "66520",
            "308066",
            "6491",
            "6699",
            "40043",
            "6542",
            "6725",
            "6556",
            "46051",
            "301438",
            "6775",
            "46460",
            "6472",
            "6662",
            "6524",
            "45277",
            "6713",
            "6368",
            "4468",
            "6506",
            "46558",
            "40462",
            "46719",
            "311252",
            "46718",
            "6773",
            "5648",
            "6733",
            "45453",
            "46620",
            "46301",
            "4523",
            "309865",
            "46677",
            "303957",
            "46624",
            "6619",
            "40607",
            "46440",
            "6587",
            "45752",
            "60856",
            "6406",
            "300079",
            "60828",
            "40488",
            "304158",
            "301239",
            "6387",
            "302473",
            "5961",
            "300440",
            "46590",
            "40415",
            "40429",
            "46696",
            "308609",
            "6647",
            "301475",
            "46220",
            "40028",
            "46232",
            "6539",
            "46350",
            "6329",
            "6677",
            "46496",
            "46415",
            "46596",
            "45052",
            "308046",
            "6325",
            "60871",
            "311478",
            "46442",
            "46653",
            "40504",
            "45757",
            "6048",
            "40405",
            "6344",
            "311477",
            "310801",
            "304455",
            "6676",
            "304539",
            "6277",
            "46585",
            "45230",
            "6413",
            "6033",
            "308608",
            "6415",
            "6750",
            "60821",
            "46565",
            "300639",
            "301533",
            "46614",
            "40402",
            "5716",
            "40075",
            "4555",
            "5009",
            "6229",
            "300461",
            "66599",
            "46191",
            "46533",
            "6722",
            "45574",
            "45425",
            "307951",
            "45262",
            "303452",
            "5183",
            "45366",
            "6412",
            "45176",
            "46727",
            "45486",
            "46676",
            "46514",
            "301516",
            "46245",
            "45911",
            "6293",
            "300455",
            "6628",
            "66563",
            "310456",
            "40107",
            "46491",
            "46098",
            "300274",
            "3890",
            "6710",
            "46517",
            "6625",
            "303101",
            "6337",
            "306180",
            "6604",
            "45340",
            "310820",
            "40064",
            "46414",
            "300358",
            "40582",
            "46381",
            "311300",
            "306068",
            "302086",
            "309497",
            "6393",
            "46166",
            "302432",
            "6720",
            "6598",
            "6742",
            "6745",
            "46326",
            "46484",
            "308264",
            "301936",
            "45950",
            "46315",
            "6345",
            "6567",
            "40045",
            "45749",
            "301627",
            "6544",
            "45921",
            "46504",
            "45847",
            "6618",
            "302210",
            "309761",
            "308041",
            "6649",
            "6304",
            "6576",
            "6210",
            "46498",
            "66121",
            "311173",
            "310853",
            "60854",
            "6480",
            "45217",
            "40401",
            "308897",
            "45702",
            "40507",
            "46105",
            "6577",
            "6360",
            "304281",
            "40411",
            "45540",
            "46722",
            "309513",
            "6595",
            "45928",
            "6546",
            "40046",
            "6607",
            "6324",
            "304530",
            "301305",
            "301442",
            "6429",
            "2661",
            "45521",
            "46122",
            "310758",
            "46251",
            "6365",
            "40585",
            "46286",
            "4553",
            "45896",
            "6693",
            "308551",
            "40070",
            "40419",
            "45452",
            "300569",
            "6655",
            "309665",
            "6495",
            "6428",
            "45748",
            "6176",
            "46700",
            "40297",
            "46212",
            "6468",
            "6547",
            "304392",
            "6525",
            "45290",
            "311840",
            "6450",
            "6669",
            "46550",
            "300445",
            "6351",
            "4500",
            "301691",
            "310730",
            "311865",
            "4809",
            "6431",
            "46511",
            "46172",
            "40008",
            "40503",
            "6321",
            "1509",
            "4864",
            "5792",
            "4583",
            "6103",
            "46510",
            "302072",
            "40614",
            "5456",
            "45329",
            "46616",
            "46560",
            "300111",
            "5413",
            "46264",
            "308377",
            "300200",
            "6294",
            "309470",
            "46661",
            "45985",
            "6363",
            "46654",
            "6486",
            "6392",
            "4608",
            "5825",
            "301599",
            "45671",
            "304515",
            "301276",
            "40175",
            "40047",
            "40048",
            "66009",
            "60201",
            "40080",
            "310986",
            "310054",
            "6768",
            "45883",
            "4865",
            "46538",
            "40565",
            "46669",
            "301504",
            "46705",
            "309583",
            "310296",
            "5314",
            "45278",
            "46263",
            "45255",
            "40016",
            "6578",
            "300499",
            "6326",
            "308345",
            "300245",
            "308330",
            "40561",
            "46631",
            "46738",
            "45387",
            "6492",
            "304332",
            "6654",
            "6601",
            "301240",
            "303252",
            "309602",
            "46253",
            "40024",
            "6763",
            "46038",
            "5827",
            "45326",
            "40562",
            "311937",
            "310486",
            "311913",
            "6743",
            "6380",
            "6306",
            "6330",
            "6498",
            "40563",
            "303643",
            "45656",
            "300732",
            "46651",
            "60091",
            "46374",
            "6637",
            "46003",
            "40600",
            "46231",
            "46563",
            "5700",
            "6313",
            "40082",
            "6343",
            "311804",
            "308604",
            "301196",
            "6404",
            "6767",
            "45416",
            "46584",
            "6487",
            "5338",
            "6612",
            "46541",
            "66425",
            "6570",
            "66555",
            "45625",
            "302278",
            "6388",
            "5584",
            "40509",
            "5665",
            "309940",
            "46716",
            "310544",
            "45665",
            "5957",
            "46568",
            "6759",
            "40018",
            "45598",
            "300153",
            "40185",
            "6353",
            "45058",
            "6771",
            "45131",
            "40526",
            "6615",
            "40121",
            "6533",
            "40144",
            "6536",
            "6488",
            "303437",
            "1548",
            "46735",
            "6439",
            "6400",
            "45460",
            "45566",
            "6509",
            "6732",
            "40051",
            "307929",
            "6296",
            "45196",
            "46674",
            "6727",
            "45371",
            "6469",
            "311576",
            "40005",
            "301716",
            "45207",
            "6395",
            "6440",
            "301744",
            "46526",
            "4986",
            "300017",
            "46113",
            "46103",
            "300342",
            "40006",
            "45807",
            "46714",
            "302060"
        ]
        url = "https://api.video.dmm.co.jp/graphql"
        for maker in makers:
            payload = {
                "query": query,
                "variables": {
                    "filter": {
                        "isSaleItemsOnly": False,
                        "makerIds": {
                            "ids": [
                                {
                                    "id": maker
                                }
                            ],
                            "op": "AND"
                        }
                    },
                    "limit": 120,
                    "offset": 0
                }
            }
            yield scrapy.Request(
                url=url,
                method="POST",
                body=json.dumps(payload),
                callback=self.parse,
                meta={"payload": payload}
            )

    def parse(self, response):
        data = json.loads(response.text)
        result = data["data"]["legacySearchPPV"]["result"]
        item_query_path = os.path.join(os.path.dirname(
            __file__), '..', 'query', 'content_page_data.graphql')
        with open(item_query_path, "r", encoding="utf-8") as f:
            item_query = f.read()
        for content in result["contents"]:
            item_payload = {
                "query": item_query,
                "variables": {
                    "id": content["id"],
                    "isAmateur": False,
                    "isAnime": False,
                    "isAv": True
                }
            }
            yield scrapy.Request(
                url=response.url,
                method="POST",
                body=json.dumps(item_payload),
                callback=self.parse_item
            )
        if result["pageInfo"]["hasNext"]:
            next_payload = response.meta["payload"]
            next_payload["variables"]["offset"] += 120
            yield scrapy.Request(
                url=response.url,
                method="POST",
                body=json.dumps(next_payload),
                callback=self.parse,
                meta={"payload": next_payload}
            )

    def parse_item(self, response):
        data = json.loads(response.text)
        item = data["data"]["ppvContent"]
        yield item
