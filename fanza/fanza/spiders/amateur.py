import scrapy
import json
import os


class AmateurSpider(scrapy.Spider):
    name = "amateur"
    custom_settings = {
        "ITEM_PIPELINES": {
            "fanza.pipelines.AmateurPipeline": 300,
        }
    }

    async def start(self):
        query_path = os.path.join(os.path.dirname(
            __file__), '..', 'query', 'amateur_search.graphql')
        with open(query_path, "r", encoding="utf-8") as f:
            query = f.read()
        labels = [
            "2064854",
            "26440",
            "46145",
            "26468",
            "2064694",
            "46183",
            "2066015",
            "2064528",
            "2063136",
            "46149",
            "2062412",
            "2062484",
            "29805",
            "24390",
            "7934",
            "2063501",
            "22583",
            "22569",
            "2063023",
            "7184",
            "2063546",
            "2067436",
            "22674",
            "2062920",
            "2065983",
            "2064179",
            "2066523",
            "2065216",
            "23186",
            "2065970",
            "2062582",
            "2065440",
            "25630",
            "25687",
            "26126",
            "25760",
            "2062700",
            "2065987",
            "46168",
            "2062979",
            "29803",
            "25494",
            "46080",
            "2064855",
            "46200",
            "2062927",
            "46084",
            "23054",
            "46079",
            "26034",
            "2065409",
            "2064130",
            "2065715",
            "2062450",
            "9897",
            "2066137",
            "46016",
            "2066037",
            "2063855",
            "45997",
            "46189",
            "24619",
            "24321",
            "23475",
            "25873",
            "24257",
            "25372",
            "46106",
            "46140",
            "5356",
            "25561",
            "2063201",
            "25767",
            "29821",
            "7028",
            "2065709",
            "25191",
            "26445",
            "25699",
            "2063010",
            "2063034",
            "25227",
            "2067337",
            "2063556",
            "2064680",
            "23682",
            "2066385",
            "23586",
            "24611",
            "25747",
            "2064692",
            "26027",
            "2067492",
            "25423",
            "26486",
            "46085",
            "46175",
            "26312",
            "2063058",
            "46202",
            "2065961",
            "24279",
            "23462",
            "2064828",
            "25940",
            "25853",
            "8907",
            "25943",
            "2062740",
            "2066835",
            "2065613",
            "2062933",
            "2066014",
            "25010",
            "2063018",
            "25534",
            "24212",
            "25439",
            "2065797",
            "9807",
            "25777",
            "25232",
            "25899",
            "24560",
            "25221",
            "25998",
            "26430",
            "2064040",
            "2063154",
            "46178",
            "2065727",
            "2065093",
            "2065077",
            "23690",
            "2065478",
            "2066962",
            "2066928",
            "2066916",
            "2067050",
            "2064406",
            "2064467",
            "22590",
            "25424",
            "2066538",
            "46063",
            "2062688",
            "2066386",
            "2063762",
            "6103",
            "2064883",
            "26295",
            "46123",
            "2063482",
            "25485",
            "26129",
            "2066813",
            "29800",
            "25228",
            "46069",
            "26420",
            "29813",
            "46068",
            "2067288",
            "2065815",
            "2067313",
            "25715",
            "7821",
            "23039",
            "46201",
            "26237",
            "2065050",
            "2062856",
            "2062865",
            "22250",
            "2064682",
            "2062488",
            "2066229",
            "2066946",
            "2063405",
            "46182",
            "46194",
            "2067008",
            "25212",
            "46081",
            "46169",
            "2067534",
            "2067024",
            "24952",
            "2067448",
            "25749",
            "46156",
            "2065845",
            "46185",
            "46187",
            "24377",
            "22188",
            "26491",
            "2063793",
            "46204",
            "23156",
            "2064888",
            "26022",
            "2065049",
            "2066999",
            "2067065",
            "26238",
            "26041",
            "24442",
            "23318",
            "23344",
            "2067125",
            "24211",
            "46170",
            "2066399",
            "2065374",
            "2065915",
            "2063339",
            "2066210",
            "46022",
            "2062424",
            "2064128",
            "2067387",
            "2062985",
            "2067372",
            "46108",
            "2062864",
            "2066977",
            "46076",
            "24044",
            "2063062",
            "46165",
            "2066740",
            "2066426",
            "2065115",
            "26489",
            "2063365",
            "8612",
            "2063209",
            "24048",
            "2063155",
            "46203",
            "46190",
            "2063082",
            "2064454",
            "2062472",
            "25220",
            "2065994",
            "2064045",
            "24045",
            "2066674",
            "2063384",
            "2065217",
            "2062981",
            "2062463",
            "23659",
            "2062689",
            "2064724",
            "2062863",
            "25833",
            "2063601",
            "23809",
            "2064557",
            "2066254",
            "24864",
            "2063602",
            "2063599",
            "46086",
            "2066923",
            "2064569",
            "46205",
            "9899",
            "2066306",
            "2063206",
            "2065642",
            "46152",
            "26349",
            "46132",
            "2063003",
            "2063534",
            "25882",
            "26359",
            "2064054",
            "26302",
            "2066397",
            "46173",
            "2064686",
            "2064576",
            "2063241",
            "2067193",
            "26292",
            "2067019",
            "2067274",
            "2067437",
            "2065974",
            "2067593",
            "2067020",
            "2065973",
            "2067275",
            "2067449",
            "46092",
            "2067360",
            "2066780",
            "2065719",
            "2063761",
            "2065714",
            "2065610",
            "2065611",
            "2064469",
            "2065088",
            "2066082",
            "2065612",
            "2065986",
            "2062899",
            "2067489",
            "2064453",
            "2067052",
            "2067120",
            "2067080",
            "2067051",
            "2067119",
            "2067079",
            "46136",
            "23047",
            "2063502",
            "2062866",
            "2062939",
            "22675",
            "7933",
            "2063298",
            "25652",
            "46157",
            "2062750",
            "2062980",
            "2064501",
            "2062705",
            "46199",
            "2062406",
            "2062986",
            "2065717",
            "2064000",
            "2065051",
            "2063721",
            "2063969",
            "26082",
            "23714",
            "46176",
            "22878",
            "2062770",
            "26157",
            "2065762",
            "2065967",
            "46196",
            "25211",
            "25725",
            "46163",
            "26399",
            "2064634",
            "2067397",
            "26452",
            "46091",
            "2063592",
            "2063468",
            "2063127",
            "2063559",
            "2062451",
            "2066304",
            "24761",
            "2063796",
            "26083",
            "25532",
            "2067190",
            "22316",
            "26225",
            "24943",
            "2063417",
            "2063046",
            "2064678",
            "2066189",
            "25985",
            "5051",
            "23407",
            "26461",
            "25843",
            "2067187",
            "2067330",
            "2067292",
            "2067189",
            "2062857",
            "26314",
            "9898",
            "2063416",
            "2065078",
            "2066347",
            "2063652",
            "25973",
            "2063649",
            "46122",
            "2065724",
            "24895",
            "26212",
            "26045",
            "2062827",
            "2067015",
            "2067017",
            "46089",
            "2065816",
            "24095",
            "26239",
            "2065893",
            "2066660",
            "2067486",
            "25802",
            "2063029",
            "2065718",
            "2065614",
            "23810",
            "22514",
            "24495",
            "2066629",
            "46193",
            "2065312",
            "22407",
            "2062892",
            "2062924",
            "2062862",
            "26377",
            "2065645",
            "46064",
            "2065228",
            "2064681",
            "26395",
            "2066841",
            "2063503",
            "25474",
            "2065499",
            "2066387",
            "2065684",
            "2062641",
            "26085",
            "2065608",
            "23465",
            "23869",
            "2064468",
            "46088",
            "2063831",
            "25577",
            "2065609",
            "2067066",
            "2063059",
            "2063000",
            "2067577",
            "46184",
            "2063057",
            "9808",
            "2065087",
            "24272",
            "26012",
            "24005",
            "7932",
            "26156",
            "2065817",
            "26211",
            "2066188",
            "26301",
            "24641",
            "26052",
            "25473",
            "25712",
            "2066209",
            "46166",
            "2062690",
            "46186",
            "46191",
            "2065311",
            "23052",
            "24258",
            "2063547",
            "23746",
            "2064745",
            "2064671",
            "2063021",
            "25422",
            "7114",
            "2065172",
            "25693",
            "2062383",
            "23906",
            "8182",
            "5618",
            "25792",
            "23878",
            "2063208",
            "2066398",
            "26356",
            "5987",
            "7113",
            "23113",
            "24789",
            "23241",
            "2063947",
            "5050",
            "8045",
            "2065337",
            "2066719",
            "2066454",
            "26261",
            "2064149",
            "2063760",
            "2062528",
            "2062523",
            "46153",
            "2064885",
            "23983",
            "2063055",
            "2066525",
            "8999",
            "26283",
            "2065716",
            "2066524",
            "26368",
            "46097",
            "2062557",
            "2064679",
            "22187",
            "8181",
            "2063856",
            "2067067",
            "45990",
            "8614",
            "2064570",
            "2062912",
            "24591",
            "2065607",
            "2064095",
            "22816",
            "24964",
            "25974",
            "25284",
            "8046",
            "46119",
            "2067331",
            "2065878",
            "22406",
            "2062762",
            "2067257",
            "23905",
            "25552",
            "25748",
            "2066081",
            "2067290",
            "2067291",
            "2067293",
            "2062784",
            "23319",
            "2067557",
            "25537",
            "46087",
            "46090",
            "46001",
            "24490",
            "23938",
            "46177",
            "2067273",
            "2067022",
            "2067021",
            "2067023",
            "2067016",
            "2063719",
            "26084",
            "2067363",
            "2062751",
            "2065672",
            "26282",
            "2066066",
            "2067338",
            "2065146",
            "23937",
            "25065",
            "2065576",
            "25856",
            "46179",
            "2067173",
            "2063432",
            "2063002",
            "2065134",
            "46195",
            "2063014",
            "2064323",
            "2065316",
            "46188",
            "2062850",
            "2063557",
            "9000",
            "7439",
            "2065573",
            "22952",
            "9806",
            "26483",
            "2065229",
            "23726",
            "46139",
            "29804",
            "46103",
            "2067652",
            "25729",
            "2063409",
            "2065712",
            "2063351",
            "2062594",
            "2063630",
            "22716",
            "46126"
        ]
        url = "https://api.video.dmm.co.jp/graphql"
        payload = {
            "query": query,
            "variables": {
                "filter": {
                    "isSaleItemsOnly": False,
                    "labelIds": {
                        "ids": [
                            {
                                "id": ""
                            }
                        ],
                        "op": "AND"
                    }
                },
                "limit": 120,
                "offset": 0
            }
        }
        for label in labels:
            payload["variables"]["filter"]["labelIds"]["ids"][0]["id"] = label
            yield scrapy.Request(
                url=url,
                method="POST",
                body=json.dumps(payload),
                callback=self.parse,
                meta={"payload": payload}
            )

    def parse(self, response):
        data = json.loads(response.text)
        result = data["data"]["legacySearchPPV"]["result"]
        item_query_path = os.path.join(os.path.dirname(
            __file__), '..', 'query', 'content_page_data.graphql')
        with open(item_query_path, "r", encoding="utf-8") as f:
            item_query = f.read()
        item_payload = {
            "query": item_query,
            "variables": {
                "id": "",
                "isAmateur": True,
                "isAnime": False,
                "isAv": False
            }
        }
        for content in result["contents"]:
            item_payload["variables"]["id"] = content["id"]
            yield scrapy.Request(
                url=response.url,
                method="POST",
                body=json.dumps(item_payload),
                callback=self.parse_item
            )
        if result["pageInfo"]["hasNext"]:
            next_payload = response.meta["payload"]
            next_payload["variables"]["offset"] += 120
            yield scrapy.Request(
                url=response.url,
                method="POST",
                body=json.dumps(next_payload),
                callback=self.parse,
                meta={"payload": next_payload}
            )

    def parse_item(self, response):
        data = json.loads(response.text)
        item = data["data"]["ppvContent"]
        yield item
