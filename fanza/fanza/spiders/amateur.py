import scrapy
import json
import os


class AmateurSpider(scrapy.Spider):
    name = "amateur"
    custom_settings = {
        "ITEM_PIPELINES": {
            "fanza.pipelines.AmateurPipeline": 300,
        }
    }

    async def start(self):
        query_path = os.path.join(os.path.dirname(
            __file__), '..', 'query', 'amateur_search.graphql')
        with open(query_path, "r", encoding="utf-8") as f:
            query = f.read()
        makers = [
            "303030",
            "40137",
            "40431",
            "40533",
            "40440",
            "302437",
            "40583",
            "308420",
            "302241",
            "300939",
            "40542",
            "300030",
            "300121",
            "40452",
            "46134",
            "45347",
            "301326",
            "45627",
            "45629",
            "300724",
            "45270",
            "301369",
            "311835",
            "45642",
            "300556",
            "308351",
            "302035",
            "309804",
            "303864",
            "45771",
            "308316",
            "300248",
            "304304",
            "46485",
            "46501",
            "46652",
            "46540",
            "45068",
            "300360",
            "308353",
            "40557",
            "300636",
            "40450",
            "46459",
            "40484",
            "303031",
            "40605",
            "300568",
            "40489",
            "45744",
            "40483",
            "46636",
            "304286",
            "301952",
            "306088",
            "300076",
            "45265",
            "45479",
            "308660",
            "40470",
            "308510",
            "301760",
            "40459",
            "40593",
            "46197",
            "46109",
            "45860",
            "46589",
            "46092",
            "46420",
            "40506",
            "40532",
            "45114",
            "46476",
            "300986",
            "46542",
            "40457",
            "306080",
            "45256",
            "46359",
            "40432",
            "46509",
            "300692",
            "300735",
            "46377",
            "311514",
            "301387",
            "302405",
            "45926",
            "309588",
            "45900",
            "46193",
            "46534",
            "302435",
            "46632",
            "311955",
            "46438",
            "40444",
            "40490",
            "40569",
            "40417",
            "300772",
            "40609",
            "308296",
            "46101",
            "45855",
            "302813",
            "46610",
            "46575",
            "45417",
            "46611",
            "300406",
            "310457",
            "304582",
            "300575",
            "308417",
            "46296",
            "300714",
            "46471",
            "46077",
            "46444",
            "307886",
            "45444",
            "309876",
            "46544",
            "46379",
            "46597",
            "46181",
            "46373",
            "40317",
            "40138",
            "46732",
            "40575",
            "306115",
            "303453",
            "303406",
            "6384",
            "304351",
            "310709",
            "310639",
            "310667",
            "310907",
            "302201",
            "45626",
            "46439",
            "309833",
            "46742",
            "300347",
            "309589",
            "301621",
            "45152",
            "303100",
            "46689",
            "40517",
            "301304",
            "46457",
            "46657",
            "310408",
            "40449",
            "46378",
            "40481",
            "46729",
            "40456",
            "40480",
            "311405",
            "307930",
            "311455",
            "46515",
            "45328",
            "45734",
            "40608",
            "46681",
            "303379",
            "300483",
            "300497",
            "45537",
            "302408",
            "300133",
            "308942",
            "310686",
            "301225",
            "40581",
            "40599",
            "310826",
            "46369",
            "40485",
            "40558",
            "312025",
            "310862",
            "46277",
            "311871",
            "46536",
            "40549",
            "308043",
            "40588",
            "40590",
            "46129",
            "45514",
            "40448",
            "301664",
            "40611",
            "45783",
            "303114",
            "46630",
            "303378",
            "310802",
            "310941",
            "46680",
            "46638",
            "46145",
            "45790",
            "45806",
            "311054",
            "46076",
            "40559",
            "309604",
            "304272",
            "308209",
            "301154",
            "308917",
            "40471",
            "300044",
            "301951",
            "311761",
            "300651",
            "311734",
            "40510",
            "300496",
            "310731",
            "40482",
            "46039",
            "300782",
            "40555",
            "310207",
            "309623",
            "303535",
            "40446",
            "301179",
            "45384",
            "300995",
            "46042",
            "300958",
            "40610",
            "40594",
            "300881",
            "302192",
            "300109",
            "46372",
            "308374",
            "301895",
            "46040",
            "309994",
            "303865",
            "300638",
            "300087",
            "45917",
            "300348",
            "302452",
            "300493",
            "46567",
            "301477",
            "45977",
            "302281",
            "308980",
            "46255",
            "301476",
            "301478",
            "40491",
            "310649",
            "302310",
            "40613",
            "45478",
            "309451",
            "300988",
            "304618",
            "40545",
            "46708",
            "40527",
            "301348",
            "46592",
            "46712",
            "301903",
            "46694",
            "309601",
            "40567",
            "302412",
            "302313",
            "301028",
            "311169",
            "40413",
            "310848",
            "311369",
            "311837",
            "308318",
            "312163",
            "310849",
            "308317",
            "311370",
            "311872",
            "302203",
            "311949",
            "311570",
            "310324",
            "306096",
            "301620",
            "306085",
            "304579",
            "304580",
            "303436",
            "308580",
            "304581",
            "308352",
            "302191",
            "310909",
            "311052",
            "310971",
            "310908",
            "311051",
            "310970",
            "40528",
            "45750",
            "301327",
            "300498",
            "300581",
            "45662",
            "45344",
            "301126",
            "46493",
            "40551",
            "300411",
            "300637",
            "302221",
            "300364",
            "40604",
            "300957",
            "300024",
            "300652",
            "306090",
            "301869",
            "303380",
            "301585",
            "301845",
            "40394",
            "45940",
            "40572",
            "45688",
            "300430",
            "46665",
            "306192",
            "308314",
            "40602",
            "46368",
            "46519",
            "40553",
            "46723",
            "302366",
            "311788",
            "40433",
            "40496",
            "301466",
            "301286",
            "300930",
            "301389",
            "300078",
            "309450",
            "46237",
            "301669",
            "40395",
            "46468",
            "311168",
            "45552",
            "40409",
            "46274",
            "301235",
            "300745",
            "302403",
            "308903",
            "46627",
            "45830",
            "40439",
            "46571",
            "311161",
            "311503",
            "311407",
            "311165",
            "300484",
            "46697",
            "45480",
            "301233",
            "303407",
            "309531",
            "301527",
            "46621",
            "301525",
            "40516",
            "306116",
            "46260",
            "6708",
            "46639",
            "300468",
            "310845",
            "310847",
            "40494",
            "307931",
            "46054",
            "46683",
            "308121",
            "309963",
            "311945",
            "46555",
            "300731",
            "306095",
            "304583",
            "45978",
            "45581",
            "46161",
            "309944",
            "40598",
            "304138",
            "45585",
            "300517",
            "300559",
            "300492",
            "46717",
            "304623",
            "46743",
            "303892",
            "302406",
            "40425",
            "310473",
            "301328",
            "46454",
            "304393",
            "309590",
            "306047",
            "300318",
            "40399",
            "304577",
            "6355",
            "45987",
            "302202",
            "40493",
            "301713",
            "46479",
            "304578",
            "310942",
            "300773",
            "300682",
            "312133",
            "40584",
            "300771",
            "45445",
            "309877",
            "303435",
            "46099",
            "40381",
            "46028",
            "45341",
            "46664",
            "307932",
            "40406",
            "308902",
            "46693",
            "46199",
            "46642",
            "46453",
            "46513",
            "308916",
            "40556",
            "300349",
            "40587",
            "40595",
            "304135",
            "45745",
            "46093",
            "301370",
            "45958",
            "302490",
            "302400",
            "300719",
            "46437",
            "45260",
            "303686",
            "46508",
            "300007",
            "45995",
            "45362",
            "45736",
            "46547",
            "45989",
            "300994",
            "301893",
            "309603",
            "46711",
            "45151",
            "45259",
            "45760",
            "46241",
            "45782",
            "301830",
            "45357",
            "304178",
            "300688",
            "310142",
            "309666",
            "40412",
            "301964",
            "301619",
            "300183",
            "300169",
            "40546",
            "303103",
            "46017",
            "300757",
            "309806",
            "45443",
            "46686",
            "306089",
            "309805",
            "46715",
            "40501",
            "300217",
            "302404",
            "45516",
            "45363",
            "301761",
            "310943",
            "45990",
            "45393",
            "302311",
            "300548",
            "46187",
            "304576",
            "301939",
            "45687",
            "46282",
            "46623",
            "46394",
            "45350",
            "40514",
            "311504",
            "308077",
            "45575",
            "300421",
            "311287",
            "45994",
            "46475",
            "46535",
            "308573",
            "311406",
            "311410",
            "311411",
            "300441",
            "45781",
            "312076",
            "46470",
            "40492",
            "40495",
            "40460",
            "46160",
            "46002",
            "310851",
            "310850",
            "310852",
            "310846",
            "40573",
            "311368",
            "301584",
            "6752",
            "40398",
            "311578",
            "300412",
            "306040",
            "46687",
            "308560",
            "311515",
            "303642",
            "46001",
            "46314",
            "304536",
            "46576",
            "40577",
            "311133",
            "301262",
            "300687",
            "303612",
            "40601",
            "300703",
            "302058",
            "304154",
            "40592",
            "300474",
            "301388",
            "45436",
            "45298",
            "304531",
            "45726",
            "45446",
            "40443",
            "303893",
            "45934",
            "40530",
            "40451",
            "312284",
            "46523",
            "301229",
            "306084",
            "300263",
            "301506",
            "45643",
            "40524"
        ]
        url = "https://api.video.dmm.co.jp/graphql"
        payload = {
            "query": query,
            "variables": {
                "filter": {
                    "isSaleItemsOnly": False,
                    "makerIds": {
                        "ids": [
                                {
                                    "id": ""
                                }
                        ],
                        "op": "AND"
                    }
                },
                "limit": 120,
                "offset": 0
            }
        }
        for maker in makers:
            payload["variables"]["filter"]["makerIds"]["ids"][0]["id"] = maker
            yield scrapy.Request(
                url=url,
                method="POST",
                body=json.dumps(payload),
                callback=self.parse,
                meta={"payload": payload}
            )

    def parse(self, response):
        data = json.loads(response.text)
        result = data["data"]["legacySearchPPV"]["result"]
        item_query_path = os.path.join(os.path.dirname(
            __file__), '..', 'query', 'content_page_data.graphql')
        with open(item_query_path, "r", encoding="utf-8") as f:
            item_query = f.read()
        item_payload = {
            "query": item_query,
            "variables": {
                "id": "",
                "isAmateur": True,
                "isAnime": False,
                "isAv": False
            }
        }
        for content in result["contents"]:
            item_payload["variables"]["id"] = content["id"]
            yield scrapy.Request(
                url=response.url,
                method="POST",
                body=json.dumps(item_payload),
                callback=self.parse_item
            )
        if result["pageInfo"]["hasNext"]:
            next_payload = response.meta["payload"]
            next_payload["variables"]["offset"] += 120
            yield scrapy.Request(
                url=response.url,
                method="POST",
                body=json.dumps(next_payload),
                callback=self.parse,
                meta={"payload": next_payload}
            )

    def parse_item(self, response):
        data = json.loads(response.text)
        item = data["data"]["ppvContent"]
        yield item
